<!DOCTYPE html>
<html lang=zh-CN class="bg-gray-100">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta property="og:type" content="website">

<meta name="description" content="吹雨听风独立博客">
<meta property="og:description" content="吹雨听风独立博客">


<meta name="keyword"  content="">

<link rel="shortcut icon" href="/img/favicon.ico">

<link rel="stylesheet" href="/css/tailwind.css">


<link rel="stylesheet" href="/css/typo.css">


<link rel="stylesheet" href="/css/theme.css">

<script type="text/javascript" src="/js/theme.js?v="></script>
<title>
    
        Go 实时日志收集 - 吹雨听风
    
</title>    

<body>

<div class="index-container py-2 md:py-8 px-2 md:px-0">
    <div class="main-content-wrapper max-w-4xl m-auto bg-white pt-8 pb-6 px-10">
        <header class="">
    <div class="max-w-4xl mx-auto">
        <div class="py-4 border-b border-slate-900/10 border-0 dark:border-slate-300/10 mx-0">
            <div class="relative sm:flex sm:items-center">
                <div class="flex-none sm:flex-initial">
                    <a class="flex-none overflow-hidden md:w-auto" href="/.">
                        <span class="text-xl font-bold">吹雨听风</span>
                    </a>

                    
                        <span class="hidden md:inline-block text-xs text-gray-500"><i> - 热爱写代码. </i></span>
                    
                </div>

                <div class="flex-none sm:flex-auto flex items-center sm:justify-end lg:w-0 space-x-4">
    

    

    

    

    
</div>
            </div>
        </div>
    </div>
</header>

        
        

        <main>
            
<article class="max-w-4xl mx-auto py-10 typo">
    <h1 style="margin-top: 0;">
        Go 实时日志收集
    </h1>

    <div>
        <div class="flex">
                <span>
                    <time datetime="Fri Aug 12 2022 00:00:00 GMT+0000">2022-08-12</time>
                </span>

            

            
        </div>

        
    <div class="mt-2">
        <span>标签：</span>
        
            <a class="" href="/tags/#技术"
               title="技术">技术</a>
            
                <span>,</span>
            
        
            <a class="" href="/tags/#golang"
               title="golang">golang</a>
            
                <span>,</span>
            
        
            <a class="" href="/tags/#并发编程"
               title="并发编程">并发编程</a>
            
        
    </div>

    </div>

    <section class="pt-10 ">
        <p>通常基础系统都会自动处理与收集日志，并不太需要应用来收集。但利用 go 的并发与携程能力，要实现实时的日志收集也是非常简单。</p>
<p>功能设计</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h54ajve0rlj20qf0d3q4e.jpg" alt="日志收集程序设计"></p>
<ul>
<li>主程序向指定的日志文件记录日志</li>
<li>收集程序独立于主程序之外，通过实时监控程序日志的方式即时读取新写入的日志</li>
<li>在读取到日志行之后，将其通过 channel 传送给日志处理进程</li>
<li>处理完成后视需要存储到 <code>es / logstash / influxdb</code></li>
</ul>
<p>优点</p>
<p>日志收集程序独立于主程序之外运行，对程序无侵入性。</p>
<p>实现</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> logCollection</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;bufio&quot;</span></span><br><span class="line">   <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">   <span class="string">&quot;errors&quot;</span></span><br><span class="line">   <span class="string">&quot;io&quot;</span></span><br><span class="line">   <span class="string">&quot;os&quot;</span></span><br><span class="line">   <span class="string">&quot;strings&quot;</span></span><br><span class="line">   <span class="string">&quot;syscall&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> logIno <span class="type">uint64</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">var</span> logCount <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LogLine <span class="keyword">struct</span> &#123;</span><br><span class="line">   Level      <span class="type">string</span>  <span class="string">`json:&quot;level&quot;`</span></span><br><span class="line">   TS         <span class="type">float64</span> <span class="string">`json:&quot;ts&quot;`</span></span><br><span class="line">   Caller     <span class="type">string</span>  <span class="string">`json:&quot;caller&quot;`</span></span><br><span class="line">   Msg        <span class="type">string</span>  <span class="string">`json:&quot;msg&quot;`</span></span><br><span class="line">   StackTrace <span class="type">string</span>  <span class="string">`json:&quot;stacktrace&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getFileIno</span><span class="params">(path <span class="type">string</span>)</span></span> <span class="type">uint64</span> &#123;</span><br><span class="line">   fileinfo, _ := os.Stat(path)</span><br><span class="line">   stat, ok := fileinfo.Sys().(*syscall.Stat_t)</span><br><span class="line">   <span class="keyword">if</span> !ok &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> stat.Ino</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">openLog</span><span class="params">(path <span class="type">string</span>, rc <span class="keyword">chan</span> []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">   <span class="keyword">var</span> f *os.File</span><br><span class="line">   <span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// create file if not exists</span></span><br><span class="line">   <span class="keyword">if</span> _, err = os.Stat(path); errors.Is(err, os.ErrNotExist) &#123;</span><br><span class="line">      f, err = os.Create(path)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="built_in">panic</span>(err)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      f, err = os.Open(path)</span><br><span class="line">      <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">         <span class="built_in">panic</span>(err)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   logIno = getFileIno(path)</span><br><span class="line">   <span class="keyword">if</span> logIno == <span class="number">0</span> &#123;</span><br><span class="line">      <span class="built_in">panic</span>(errors.New(<span class="string">&quot;open log file failed&quot;</span>))</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(f *os.File)</span></span> &#123;</span><br><span class="line">      _ = f.Close()</span><br><span class="line">   &#125;(f)</span><br><span class="line"></span><br><span class="line">   f.Seek(<span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">   buf := bufio.NewReader(f)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      <span class="comment">// check file ino</span></span><br><span class="line">      <span class="comment">// if changed, reopen file</span></span><br><span class="line">      <span class="keyword">if</span> logIno != getFileIno(path) &#123;</span><br><span class="line">         variable.Logger.Error(<span class="string">&quot;openLog logIno != new : &quot;</span>, logIno)</span><br><span class="line">         _ = f.Close()</span><br><span class="line"></span><br><span class="line">         f, err = os.Open(path)</span><br><span class="line">         <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            variable.Logger.ErrorF(<span class="string">&quot;open log file failed: %s\n&quot;</span>, err)</span><br><span class="line">            <span class="built_in">panic</span>(err)</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         logIno = getFileIno(path)</span><br><span class="line">         <span class="keyword">continue</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      line, err := buf.ReadBytes(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">      <span class="keyword">switch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> err == io.EOF:</span><br><span class="line">         time.Sleep(time.Second)</span><br><span class="line">      <span class="keyword">case</span> err != <span class="literal">nil</span>:</span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">         rc &lt;- line[:<span class="built_in">len</span>(line)<span class="number">-1</span>]</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Write</span><span class="params">(path <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">      <span class="keyword">for</span> &#123;</span><br><span class="line">         time.Sleep(time.Second)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;()</span><br><span class="line"></span><br><span class="line">   c := <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="type">byte</span>)</span><br><span class="line">   <span class="keyword">go</span> openLog(path, c)</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> &#123;</span><br><span class="line">      line := &lt;-c</span><br><span class="line">      process(line)</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(line []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line">   <span class="keyword">var</span> logLine LogLine</span><br><span class="line">   err := json.Unmarshal(line, &amp;logLine)</span><br><span class="line">   <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> logLine.Level == <span class="string">&quot;debug&quot;</span> || logLine.Level == <span class="string">&quot;info&quot;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 精简 trace</span></span><br><span class="line">   traces := strings.Split(logLine.StackTrace, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">   <span class="keyword">if</span> <span class="built_in">len</span>(traces) &gt; <span class="number">2</span> &#123;</span><br><span class="line">      traces = traces[<span class="number">2</span>:]</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">len</span>(traces) &gt; <span class="number">3</span> &#123;</span><br><span class="line">         traces = traces[:<span class="number">3</span>]</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   write(&amp;logLine)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">(log *LogLine)</span></span> &#123;</span><br><span class="line">   <span class="comment">// write to es</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意上面代码中的一个小细节：</p>
<p>在我们系统中，主程只负责向 <code>app.log</code> 写日志，但 <code>app.log</code> 会在每天凌晨被重命名为 <code>app_2022-08-10.log</code> 以实现日志分割。</p>
<p>那么如何检测文件被移动呢？</p>
<p>上面代码中的实现是通过 <code>file index no, fio</code> 来判断，如果打开的 <code>app.log</code> fio 与磁盘上 <code>app.log</code> 文件的 fio 不一致，则认为是创建了新的日志文件，此时再重新打开日志即可。</p>

    </section>
</article>
        </main>

        <footer class="max-w-4xl mx-auto py-2 border-t border-solid border-gray-100 text-xs pb-5">
    <div class="sm:flex space-y-2 sm:space-y-0">
        <div class="sm:flex-initial">
            
            &copy;
            
                2018 -
            
            2025

            <span>吹雨听风.</span>

            <span>
                本站由 <a class="hexo-link " target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> and
                <a target="_blank" rel="noopener" href="https://github.com/cmzz/hexo-theme-snow-white">Snow White</a>
                
                    强力驱动
                
            </span>
        </div>

        <div class="flex sm:flex-initial items-center">
            

            

            

            
                <span class="inline-block px-2 text-xs text-gray-400 hidden sm:inline-block">|</span>
                <span>
                    <a href="/links"
                       class="whitespace-nowrap text-gray-500 "> 链接 </a>
                </span>
            

            
                <span class="inline-block px-2 text-xs text-gray-400 hidden sm:inline-block">|</span>
                <span>
                    <a href="/atom.xml" title="RSS" target="_blank" rel="noopener">RSS</a>
                </span>
            

            
                <span class="inline-block px-2 text-xs text-gray-400 hidden sm:inline-block">|</span>
                <span>
                    <a href="/sitemap.xml" title="网站地图" target="_blank" rel="noopener">网站地图</a>
                </span>
            
        </div>
    </div>

    <div class="mt-2">
        <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" title="署名-非商业性使用 4.0 国际 (CC BY-NC 4.0)" target="_blank" rel="noopener">署名-非商业性使用 4.0 国际 (CC BY-NC 4.0)</a>
    </div>
</footer>




    </div>
</div>

</body>
</html>